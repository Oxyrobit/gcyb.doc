name: Auto PR from dev to main

on:
  push:
    branches:
      - dev

env:
  # Configurable threshold: number of commits before auto-creating a PR
  COMMIT_THRESHOLD: 5

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to compare branches
          
      - name: Count commits ahead of main
        id: count
        run: |
          # Fetch main branch (may fail if branch doesn't exist)
          if git fetch origin main:main 2>/dev/null; then
            # Count commits on dev that are not in main
            if git rev-parse --verify main >/dev/null 2>&1; then
              COMMIT_COUNT=$(git rev-list --count main..dev)
              echo "commits_ahead=$COMMIT_COUNT" >> $GITHUB_OUTPUT
              echo "Found $COMMIT_COUNT commit(s) on dev ahead of main"
            else
              echo "commits_ahead=0" >> $GITHUB_OUTPUT
              echo "main branch reference not found locally"
            fi
          else
            echo "commits_ahead=0" >> $GITHUB_OUTPUT
            echo "Unable to fetch main branch (may not exist yet)"
          fi
          
      - name: Check for existing open PR
        id: check_pr
        if: fromJSON(steps.count.outputs.commits_ahead) >= fromJSON(env.COMMIT_THRESHOLD)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if there's already an open PR from dev to main
          OPEN_PRS=$(gh pr list --base main --head dev --state open --json number --jq 'length')
          echo "open_prs=$OPEN_PRS" >> $GITHUB_OUTPUT
          echo "Found $OPEN_PRS open PR(s) from dev to main"
          
      - name: Create Pull Request
        if: |
          fromJSON(steps.count.outputs.commits_ahead) >= fromJSON(env.COMMIT_THRESHOLD) && 
          steps.check_pr.outputs.open_prs == '0'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the commit count for the PR description
          COMMIT_COUNT="${{ steps.count.outputs.commits_ahead }}"
          THRESHOLD="${{ env.COMMIT_THRESHOLD }}"
          
          # Create PR with properly formatted body using heredoc
          gh pr create \
            --base main \
            --head dev \
            --title "Auto PR: Sync dev to main ($COMMIT_COUNT commits)" \
            --body "$(cat <<EOF
          This PR was automatically created after reaching $COMMIT_COUNT commit(s) on the dev branch.
          
          ## Summary
          - Commits ahead: $COMMIT_COUNT
          - Threshold: $THRESHOLD
          
          Please review the changes before merging.
          
          **Auto-generated by GitHub Actions**
          EOF
          )"
          
      - name: Summary
        run: |
          COMMIT_COUNT="${{ steps.count.outputs.commits_ahead }}"
          THRESHOLD="${{ env.COMMIT_THRESHOLD }}"
          OPEN_PRS="${{ steps.check_pr.outputs.open_prs }}"
          
          echo "## Auto PR Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Commits on dev ahead of main: **$COMMIT_COUNT**" >> $GITHUB_STEP_SUMMARY
          echo "- Threshold for auto PR: **$THRESHOLD**" >> $GITHUB_STEP_SUMMARY
          
          if [ "$COMMIT_COUNT" -ge "$THRESHOLD" ]; then
            if [ "$OPEN_PRS" = "0" ]; then
              echo "- ✅ Auto PR created successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ℹ️ Auto PR not created (existing PR already open)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- ℹ️ Not enough commits yet to trigger auto PR" >> $GITHUB_STEP_SUMMARY
          fi
